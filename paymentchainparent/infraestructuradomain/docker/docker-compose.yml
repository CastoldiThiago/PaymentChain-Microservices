  services:
    # ==========================================
    # 1. INFRAESTRUCTURA DE DATOS Y SEGURIDAD
    # ==========================================
    postgres-db:
      image: postgres:15-alpine
      container_name: paymentchain-db
      ports:
        - "5432:5432"
      environment:
        - POSTGRES_USER=postgres
        - POSTGRES_PASSWORD=admin
        - POSTGRES_DB=paymentchain_db
      volumes:
        - ./postgres-data:/var/lib/postgresql/data
      networks:
        - paymentchain-network
      restart: unless-stopped

    pgadmin:
      image: dpage/pgadmin4
      container_name: pgadmin
      environment:
        PGADMIN_DEFAULT_EMAIL: admin@admin.com
        PGADMIN_DEFAULT_PASSWORD: admin
      ports:
        - "5050:80"
      depends_on:
        - postgres-db
      networks:
        - paymentchain-network
      restart: unless-stopped

    redis-cache:
      image: redis:alpine
      container_name: paymentchain-redis
      ports:
        - "6379:6379"
      networks:
        - paymentchain-network
      restart: unless-stopped

    keycloak:
      image: quay.io/keycloak/keycloak:24.0.1
      container_name: paymentchain-keycloak
      command: start-dev
      environment:
        KEYCLOAK_ADMIN: admin
        KEYCLOAK_ADMIN_PASSWORD: admin
        KC_DB: postgres
        KC_DB_URL: jdbc:postgresql://postgres-db:5432/paymentchain_db
        KC_DB_USERNAME: postgres
        KC_DB_PASSWORD: admin
        KC_HTTP_ENABLED: true
        KC_HOSTNAME_STRICT: false
        KC_HOSTNAME_STRICT_HTTPS: false
      ports:
        - "8180:8080"
      depends_on:
        - postgres-db
      networks:
        - paymentchain-network
      restart: unless-stopped

    # ==========================================
    # 2. INFRAESTRUCTURA MICROSERVICIOS
    # ==========================================
    eureka-server:
      image: paymentchain/eureka-server
      build: ../../infraestructuradomain/eurekaserver
      container_name: eureka-server
      ports:
        - "8761:8761"
      networks:
        - paymentchain-network
      healthcheck:
        test: [ "CMD", "curl", "-f", "http://localhost:8761/actuator/health" ]
        interval: 10s
        timeout: 5s
        retries: 6
      restart: unless-stopped

    config-server:
      image: paymentchain/config-server
      build: ../../infraestructuradomain/configServer
      container_name: config-server
      ports:
        - "8888:8888"
      healthcheck:
        test: [ "CMD", "curl", "-f", "http://localhost:8888/actuator/health" ]
        interval: 10s
        timeout: 5s
        retries: 6
      volumes:
        - ../../config-data:/app/config-data
      environment:
        - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
        - SPRING_EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
        - SPRING_CLOUD_CONFIG_FAILFAST=true
      depends_on:
        eureka-server:
          condition: service_healthy
      networks:
        - paymentchain-network
      restart: unless-stopped

    springboot-admin:
      image: paymentchain/springboot-admin
      build: ../../infraestructuradomain/SpringbootAdmin
      container_name: springboot-admin
      ports:
        - "9090:9090"
      environment:
        - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
        - SPRING_EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      depends_on:
        config-server:
          condition: service_healthy
      networks:
        - paymentchain-network
      restart: unless-stopped

    api-gateway:
      image: paymentchain/api-gateway
      build: ../../infraestructuradomain/apigateway
      container_name: api-gateway
      ports:
        - "8080:8080"
      environment:
        - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
        - SPRING_EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
        - SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI=http://paymentchain-keycloak:8080/realms/paymentchain-realm/protocol/openid-connect/certs
      depends_on:
        eureka-server:
          condition: service_healthy
        keycloak:
          condition: service_started
      networks:
        - paymentchain-network
      restart: unless-stopped

    # ==========================================
    # 3. DOMINIO DE NEGOCIO (SIN PUERTOS PÃšBLICOS)
    # ==========================================
    businessdomain-customer:
      image: paymentchain/customer
      build: ../../businessdomain/customer
      container_name: customer-service
      environment:
        - DB_URL=jdbc:postgresql://postgres-db:5432/paymentchain_db
        - DB_USER=postgres
        - DB_PASSWORD=admin
        - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
        - SPRING_EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      depends_on:
        config-server:
          condition: service_healthy
        postgres-db:
          condition: service_started
      networks:
        - paymentchain-network
      restart: unless-stopped

    businessdomain-transaction:
      image: paymentchain/transaction
      build: ../../businessdomain/transaction
      container_name: transaction-service
      environment:
        - DB_URL=jdbc:postgresql://postgres-db:5432/paymentchain_db
        - DB_USER=postgres
        - DB_PASSWORD=admin
        - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
        - SPRING_EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
        - CURRENCY_SERVICE_URL=http://currency-exchange:8090
      depends_on:
        config-server:
          condition: service_healthy
        postgres-db:
          condition: service_started
        currency-exchange:
          condition: service_started
      networks:
        - paymentchain-network
      restart: unless-stopped

    currency-exchange:
      image: paymentchain/currency-exchange
      build: ../../businessdomain/currency-exchange
      container_name: currency-exchange
      environment:
        - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
        - SPRING_EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
        - REDIS_HOST=paymentchain-redis
        - REDIS_PORT=6379
      depends_on:
        config-server:
          condition: service_healthy
        redis-cache:
          condition: service_started
        eureka-server:
          condition: service_healthy
      networks:
        - paymentchain-network
      restart: unless-stopped

  networks:
    paymentchain-network:
      driver: bridge
